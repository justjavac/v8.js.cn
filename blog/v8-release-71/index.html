<!doctype html><html lang=zh-CN><meta charset=utf-8><title>V8 v7.1 发布 · V8</title><meta content="width=device-width" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=" js"</script><meta content="V8 v7.1 features embedded bytecode handlers, improved TurboFan escape analysis, postMessage(wasmModule), Intl.RelativeTimeFormat, and globalThis!" name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li><a href=/tools/ >工具</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>V8 v7.1 发布</h1><p class=meta>发布时间 <time datetime="2018-10-31 15:44:37" itemprop=datePublished title="2018-10-31 15:44:37">2018-10-31</time> · 标签： <a href=/blog/tags/release/ class=tag>release</a></header><div itemprop=articleBody><p>每六周，我们会按照 <a href=/docs/release-process>V8 的发布流程</a>创建一个新的 V8 分支。在进入 Chrome Beta 里程碑之前，此版本从 V8 的 master 分支创建出来。今天我们很高兴地宣布当前最新的分支异常创建出来了，<a href=https://chromium.googlesource.com/v8/v8.git/+log/branch-heads/7.1>V8 version 7.1</a>，它将在几个星期内与 Chrome 71 Stable 同时发布。V8 v7.1 包含了各种面向开发者的新特性。这篇文章提供了预期发布的一些功能亮点。<h2 id=memory>内存 <a href=#memory class=bookmark>#</a></h2><p>在 v6.9/v7.0 中<a href=/blog/embedded-builtins>将内置函数直接以二进制方式嵌入</a>后，解释器的字节码处理程序现在也<a href="https://bugs.chromium.org/p/v8/issues/detail?id=8068">嵌入到二进制文件中</a>。每个 Isolate 平均节省大约 200 KB。<h2 id=performance>性能 <a href=#performance class=bookmark>#</a></h2><p>TurboFan 中的逃逸分析（对局部作用域的对象执行标量替换）得到了改进，当来自周围上下文的变量转移到本地闭包时，它还能够<a href=https://bit.ly/v8-turbofan-context-sensitive-js-operators>处理高阶函数的局部函数上下文</a>。请考虑以下示例：<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">mapAdd</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> a<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">y</span> <span class="token operator">=></span> y <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>注意，这里的 <code>x</code> 是局部作用域闭包 <code>y => y + x</code> 的自由变量。V8 v7.1 现在可以完全忽略上下文中分配的 <code>x</code>，在某些情况下可以提高 40%。<figure><img alt="" height=371 src=/_img/v8-release-71/improved-escape-analysis.svg width=705 loading=lazy><figcaption>通过新的逃逸分析提升性能（越低越好）</figcaption></figure><p>逃逸分析现在还能够消除使用变量作为索引访问局部数据的行为。下面是一个例子：<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><br>    total <span class="token operator">+=</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> total<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">sum2</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">sum</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>请注意，<code>args</code> 是 <code>sum2</code> 的局部变量（假设 <code>sum</code> 被内联进了 <code>sum2</code>）。在 V8 v7.1 中，TurboFan 现在可以把 <code>args</code> 完全消除，并使用三元操作 <code>i === 0 ? x : y</code> 替换变量索引访问操作 <code>args[i]</code>。在使用 JetStream/EarleyBoyer 进行基准测试时，性能提高了约 2%。我们将来会继续扩展此优化，使具有两个以上元素的数组也可以进行类似优化。<h2 id=structured-cloning-of-wasm-modules>Wasm modules 的结构化克隆 <a href=#structured-cloning-of-wasm-modules class=bookmark>#</a></h2><p>最后，<a href=https://github.com/WebAssembly/design/pull/1074><code>postMessage</code> is supported for Wasm modules</a>。<code>WebAssembly.Module</code> 对象现在可以被 <code>postMessage</code> 发送到 web workers。为了更加清晰，这仅限于 web workers（相同的进程，不同的线程），而不能扩展到跨进程场景（例如跨域(cross-origin) <code>postMessage</code> 或 shared web workers）。<h2 id=javascript-language-features>JavaScript 语言新特性 <a href=#javascript-language-features class=bookmark>#</a></h2><p><a href=/features/intl-relativetimeformat><code>Intl.RelativeTimeFormat</code> API</a> 可以让我们处理相对时间的本地化格式（例如，“昨天”，“42秒前”或“3个月”），而不牺牲性能。下面是一个例子：<pre class=language-js><code class=language-js><span class="token comment">// 创建一个本地化相对时间，中文</span><br><span class="token keyword">const</span> rtf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intl<span class="token punctuation">.</span>RelativeTimeFormat</span><span class="token punctuation">(</span><span class="token string">'zh'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">numeric</span><span class="token operator">:</span> <span class="token string">'auto'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>rtf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'day'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// → '昨天'</span><br><br>rtf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'day'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// → '今天'</span><br><br>rtf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'day'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// → '明天'</span><br><br>rtf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'week'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// → '上周'</span><br><br>rtf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'week'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// → '本周'</span><br><br>rtf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'week'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// → '下周'</span></code></pre><p>有关 <code>Intl.RelativeTimeFormat</code> 的更多信息，请阅读 Google Web Fundamentals 的 <a href=/features/intl-relativetimeformat>The Intl.RelativeTimeFormat API</a> 文章，中文翻译版<a href=https://zhuanlan.zhihu.com/p/47417391>国际化相对时间格式化API：Intl.RelativeTimeFormat</a>。<p>V8 v7.1 还增加了对 <a href=https://github.com/tc39/proposal-global><code>globalThis</code> 提案</a>的支持，此提案提供了访问全局对象的通用机制，即使在严格模式的函数或模块中，而不管平台如何。<h2 id=v8-api>V8 API <a href=#v8-api class=bookmark>#</a></h2><p>请使用 <code>git log branch-heads/7.0..branch-heads/7.1 include/v8.h</code> 获取 API 的变更列表。<p>开发者可以使用 <code>git checkout -b 7.1 -t branch-heads/7.1</code> 来使用 V8 v7.1 中的实验性新功能，具体请参阅<a href=/docs/source-code#using-git>使用 Git 获取 V8 源码</a>。或者，您可以订阅 <a href=https://www.google.com/chrome/browser/beta.html>Chrome 的 Beta 频道</a> 来尽快尝试新功能。</div><footer><div><picture><source srcset="/_img/avatars/stephan-herhut.avif, /_img/avatars/stephan-herhut@2x.avif 2x" type=image/avif><img alt="" height=96 src=/_img/avatars/stephan-herhut.jpg width=96 loading=lazy srcset="/_img/avatars/stephan-herhut@2x.jpg 2x"></picture><p>作者：Stephan Herhut (<a href=https://twitter.com/herhut>@herhut</a>), cloned cloner of clones.</div><a href=https://twitter.com/v8js/status/1057645773465235458 class=retweet>Retweet this article!</a></footer><footer><div><img alt="" height=96 src=/_img/avatars/justjavac.jpg width=96 srcset="/_img/avatars/justjavac@2x.jpg 2x" lazyload=on><p>译者：迷渡 (<a href=https://github.com/justjavac>@justjavac</a>)，V8.js.cn 站长.</div></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/blog/v8-release-71>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/blog/v8-release-71.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>