<!doctype html><html lang=zh-CN><meta charset=utf-8><title>V8 release v8.4 · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="V8 v8.4 features weak references and improved WebAssembly performance." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>V8 release v8.4</h1><p class=meta>发布时间 <time datetime="2020-06-30 00:00:00" itemprop=datePublished title="2020-06-30 00:00:00">2020-06-30</time> · 标签： <a href=/blog/tags/release/ class=tag>release</a></header><div itemprop=articleBody><p>Every six weeks, we create a new branch of V8 as part of our <a href=https://v8.dev/docs/release-process>release process</a>. Each version is branched from V8’s Git master immediately before a Chrome Beta milestone. Today we’re pleased to announce our newest branch, <a href=https://chromium.googlesource.com/v8/v8.git/+log/branch-heads/8.4>V8 version 8.4</a>, which is in beta until its release in coordination with Chrome 84 Stable in several weeks. V8 v8.4 is filled with all sorts of developer-facing goodies. This post provides a preview of some of the highlights in anticipation of the release.<h2 id=webassembly>WebAssembly <a href=#webassembly class=bookmark>#</a></h2><h3 id=improved-start-up-time>Improved start-up time <a href=#improved-start-up-time class=bookmark>#</a></h3><p>WebAssembly’s baseline compiler (<a href=https://v8.dev/blog/liftoff>Liftoff</a>) now supports <a href=https://github.com/WebAssembly/threads>atomic instructions</a> and <a href=https://github.com/WebAssembly/bulk-memory-operations>bulk memory operations</a>. This means that even if you use these pretty recent spec additions, you get blazingly fast start-up times.<h3 id=better-debugging>Better debugging <a href=#better-debugging class=bookmark>#</a></h3><p>In an ongoing effort to improve the debugging experience in WebAssembly, we are now able to inspect any WebAssembly frame that is live whenever you pause execution or reach a breakpoint.<br>This was realized by re-using <a href=https://v8.dev/blog/liftoff>Liftoff</a> for debugging. In the past, all code that had breakpoints or was stepped through needed to execute in the WebAssembly interpreter, which slowed down execution substantially (often around 100×). With Liftoff, you only lose about one third of your performance, but you can step through all code and inspect it at any time.<h3 id=simd-origin-trial>SIMD Origin Trial <a href=#simd-origin-trial class=bookmark>#</a></h3><p>The SIMD proposal enables WebAssembly to take advantage of commonly available hardware vector instructions to accelerate compute intensive workloads. V8 has <a href=https://v8.dev/features/simd>support</a> for the <a href=https://github.com/WebAssembly/simd>WebAssembly SIMD proposal</a>. To enable this in Chrome, use the flag <code>chrome://flags/#enable-webassembly-simd</code> or sign up for an <a href=https://developers.chrome.com/origintrials/#/view_trial/-4708513410415853567>origin trial</a>. <a href=https://github.com/GoogleChrome/OriginTrials/blob/gh-pages/developer-guide.md>Origin trials</a> allow developers to experiment with a feature before it is standardized, and provide valuable feedback. Once an origin has opted into the trial users are opted into the feature for the duration of the trial period without having to update Chrome flags.<h2 id=javascript>JavaScript <a href=#javascript class=bookmark>#</a></h2><h3 id=weak-references-and-finalizers>Weak references and finalizers <a href=#weak-references-and-finalizers class=bookmark>#</a></h3><div class=note><p><strong>Warning!</strong> Weak references and finalizers are advanced features! They depend on garbage collection behavior. Garbage collection is non-deterministic and may not occur at all.</div><p>JavaScript is a garbage collected language, which means memory occupied by objects that are no longer reachable by the program may be automatically reclaimed when the garbage collector runs. With the exception of references in <code>WeakMap</code> and <code>WeakSet</code>, all references in JavaScript are strong and prevent the referenced object from being garbage collected. For instance,<pre class=language-js><code class=language-js><span class="token keyword">const</span> globalRef <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token comment">// As long as globalRef is reachable through the global scope,</span><br><span class="token comment">// neither it nor the function in its callback property will be collected.</span></code></pre><p>JavaScript programmers can now hold on to objects weakly via the <code>WeakRef</code> feature. Objects that are referenced by weak references do not prevent their being garbage collected if they are not also strongly referenced.<pre class=language-js><code class=language-js><span class="token keyword">const</span> globalWeakRef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  globalWeakRef<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// Logs “foo” to console. globalWeakRef is guaranteed to be alive</span><br>  <span class="token comment">// for the first turn of the event loop after it was created.</span><br><br>  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// Wait for a turn of the event loop.</span><br><br>  globalWeakRef<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// The object inside globalWeakRef may be garbage collected</span><br>  <span class="token comment">// after the first turn since it is not otherwise reachable.</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The companion feature to <code>WeakRef</code>s is <code>FinalizationRegistry</code>, which lets programmers register callbacks to be invoked after an object is garbage collected. For example, the program below may log <code>42</code> to the console after the unreachable object in the IIFE is collected.<pre class=language-js><code class=language-js><span class="token keyword">const</span> registry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalizationRegistry</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">heldValue</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>heldValue<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> garbage <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>  registry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>garbage<span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// The second argument is the “held” value which gets passed</span><br>  <span class="token comment">// to the finalizer when the first argument is garbage collected.</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Finalizers are scheduled to run on the event loop and never interrupt synchronous JavaScript execution.<p>These are advanced and powerful features, and with any luck, your program won’t need them. Please see our <a href=https://v8.dev/features/weak-references>explainer</a> to learn more about them!<h3 id=private-methods-and-accessors>Private methods and accessors <a href=#private-methods-and-accessors class=bookmark>#</a></h3><p>Private fields, which shipped in v7.4, are rounded out with support for private methods and accessors. Syntactically, the names of private methods and accessors start with <code>#</code>, just like private fields. The following is a brief taste of the syntax.<pre class=language-js><code class=language-js><span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span><br>  <span class="token function">#privateMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"I'm only callable inside Component!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">get</span> <span class="token function">#privateAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">42</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><br>  <span class="token keyword">set</span> <span class="token function">#privateAccessor</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Private methods and accessors have the same scoping rules and semantics as private fields. Please see our <a href=https://v8.dev/features/class-fields>explainer</a> to learn more.<p>Thanks to <a href=https://twitter.com/igalia>Igalia</a> for contributing the implementation!<h2 id=v8-api>V8 API <a href=#v8-api class=bookmark>#</a></h2><p>Please use <code>git log branch-heads/8.3..branch-heads/8.4 include/v8.h</code> to get a list of the API changes.<p>Developers with an active V8 checkout can use <code>git checkout -b 8.4 -t branch-heads/8.4</code> to experiment with the new features in V8 v8.4. Alternatively you can <a href=https://www.google.com/chrome/browser/beta.html>subscribe to Chrome’s Beta channel</a> and try the new features out yourself soon.</div><footer><div><picture><source srcset="/_img/avatars/camillo-bruni.avif, /_img/avatars/camillo-bruni@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/camillo-bruni.jpg srcset="/_img/avatars/camillo-bruni@2x.jpg 2x" width=96></picture><p>作者：Camillo Bruni, enjoying some fresh booleans.</div><a href=https://twitter.com/v8js/status/1277983235641761795 class=retweet>Retweet this article!</a></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/blog/v8-release-84>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/blog/v8-release-84.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>