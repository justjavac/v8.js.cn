<!doctype html><html lang=zh-CN><meta charset=utf-8><title>Chrome 的一小步，V8 的一大堆 · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="V8 最近增加了对堆大小的硬限制。" name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>Chrome 的一小步，V8 的一大堆</h1><p class=meta>发布时间 <time datetime="2017-02-09 13:33:37" itemprop=datePublished title="2017-02-09 13:33:37">2017-02-09</time> · 标签： <a href=/blog/tags/memory/ class=tag>memory</a></header><div itemprop=articleBody><p>V8 对其堆大小有硬性限制。这可以防止应用程序发生内存泄漏。当应用程序达到这个硬限制时，V8 会执行一系列最后的垃圾回收。如果垃圾回收对释放内存没有帮助，V8 将停止执行并报告内存不足（out-of-memory）故障。如果没有硬性限制，内存泄漏应用程序可能会耗尽所有系统内存，从而损害其它应用程序的性能。<p>具有讽刺意味的是，这种保护机制使 JavaScript 开发人员更难调查内存泄漏。在开发人员设法检查 DevTools 中的堆之前，应用程序可能会耗尽内存。此外，DevTools 进程本身可能会耗尽内存，因为它使用的是普通 V8 实例。例如，获取<a href=https://ulan.github.io/misc/heap-snapshot-demo.html>此演示</a>的堆快照会由于当前稳定的 Chrome 内存不足（out-of-memory ）而中止执行。<p>历史上，V8 堆限制被方便地设置为适合有符号的 32 位整数范围和一些余量。随着时间的推移，这种便利导致 V8 中的代码松散，混合不同位宽的类型，有效地打破了增加限制的能力。最近我们清理了垃圾回收器代码，允许使用更大的堆大小。DevTools 已经使用了这个功能，并且在前面提到的演示中获取堆快照在最新的 Chrome Canary 中可以按预期工作。<p>我们还在 DevTools 中添加了一项功能，可以在应用程序快要用尽内存时暂停应用程序。此功能对于调查导致应用程序在短时间内分配大量内存的错误很有用。当使用最新的 Chrome Canary 版本运行<a href=https://ulan.github.io/misc/oom.html>此演示</a>时，DevTools 在内存不足故障之前暂停应用程序并增加堆限制，使用户有机会检查堆，在控制台上评估表达式以释放内存，然后恢复执行以便进一步调试。<figure><img alt="" height=836 loading=lazy src=/_img/heap-size-limit/debugger.png width=1362></figure><p>V8 嵌入器可以使用 <code>ResourceConstraints</code> API 的 <a href="https://codesearch.chromium.org/chromium/src/v8/include/v8.h?q=set_max_old_space_size"><code>set_max_old_space_size</code></a> 函数增加堆限制。但请注意，垃圾回收器中的某些阶段对堆大小具有线性依赖性。垃圾回收停顿可能会随着更大的堆而增加。</div><footer><div><picture><source srcset="/_img/avatars/ulan-degenbaev.avif, /_img/avatars/ulan-degenbaev@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/ulan-degenbaev.jpg width=96 srcset="/_img/avatars/ulan-degenbaev@2x.jpg 2x"></picture><picture><source srcset="/_img/avatars/michael-lippautz.avif, /_img/avatars/michael-lippautz@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/michael-lippautz.jpg width=96 srcset="/_img/avatars/michael-lippautz@2x.jpg 2x"></picture><picture><source srcset="/_img/avatars/hannes-payer.avif, /_img/avatars/hannes-payer@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/hannes-payer.jpg width=96 srcset="/_img/avatars/hannes-payer@2x.jpg 2x"></picture><p>作者：guardians of the heap Ulan Degenbaev, Hannes Payer, Michael Lippautz, and DevTools warrior Alexey Kozyatinskiy.</div></footer><footer><div><p>译者：不如怀念 (<a href=https://github.com/wang1212>@wang1212</a>).</div></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/blog/heap-size-limit>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/blog/heap-size-limit.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>