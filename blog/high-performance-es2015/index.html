<!doctype html><html lang=zh-CN><meta charset=utf-8><title>High-performance ES2015 and beyond · V8</title><meta content="width=device-width" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=" js"</script><meta content="V8’s performance of ES2015+ language features is now on par with their transpiled ES5 counterparts." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li><a href=/tools/ >工具</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>High-performance ES2015 and beyond</h1><p class=meta>发布时间 <time datetime="2017-02-17 13:33:37" itemprop=datePublished title="2017-02-17 13:33:37">2017-02-17</time> · 标签： <a href=/blog/tags/ecmascript/ class=tag>ECMAScript</a></header><div itemprop=articleBody><p>Over the last couple of months the V8 team focused on bringing the performance of newly added <a href=https://www.ecma-international.org/ecma-262/6.0/ >ES2015</a> and other even more recent JavaScript features on par with their transpiled <a href=https://www.ecma-international.org/ecma-262/5.1/ >ES5</a> counterparts.<h2 id=motivation>Motivation <a href=#motivation class=bookmark>#</a></h2><p>Before we go into the details of the various improvements, we should first consider why performance of ES2015+ features matter despite the widespread usage of <a href=http://babeljs.io/ >Babel</a> in modern web development:<ol><li>First of all there are new ES2015 features that are only polyfilled on demand, for example the <a href=https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Object/assign><code>Object.assign</code></a> builtin. When Babel transpiles <a href=https://github.com/sebmarkbage/ecmascript-rest-spread>object spread properties</a> (which are heavily used by many <a href=https://facebook.github.io/react>React</a> and <a href=http://redux.js.org/ >Redux</a> applications), it relies on <a href=https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Object/assign><code>Object.assign</code></a> instead of an ES5 equivalent if the VM supports it.<li>Polyfilling ES2015 features typically increases code size, which contributes significantly to the current <a href=https://channel9.msdn.com/Blogs/msedgedev/nolanlaw-web-perf-crisis>web performance crisis</a>, especially on mobile devices common in emerging markets. So the cost of just delivering, parsing and compiling the code can be fairly high, even before you get to the actual execution cost.<li>And last but not least, the client-side JavaScript is only one of the environments that relies on the V8 engine. There’s also <a href=https://nodejs.org/ >Node.js</a> for server side applications and tools, where developers don’t need to transpile to ES5 code, but can directly use the features supported by the <a href=https://nodejs.org/en/download/releases/ >relevant V8 version</a> in the target Node.js release.</ol><p>Let’s consider the following code snippet from the <a href=http://redux.js.org/docs/recipes/UsingObjectSpreadOperator.html>Redux documentation</a>:<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">todoApp</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> initialState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">case</span> <span class="token constant">SET_VISIBILITY_FILTER</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> <span class="token literal-property property">visibilityFilter</span><span class="token operator">:</span> action<span class="token punctuation">.</span>filter <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token keyword">default</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> state<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>There are two things in that code that demand transpilation: the default parameter for state and the spreading of state into the object literal. Babel generates the following ES5 code:<pre class=language-js><code class=language-js><span class="token string">'use strict'</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> _extends <span class="token operator">=</span> Object<span class="token punctuation">.</span>assign <span class="token operator">||</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> source <span class="token operator">=</span> arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">return</span> target<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">todoApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> state <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&&</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> initialState<span class="token punctuation">;</span><br>  <span class="token keyword">var</span> action <span class="token operator">=</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">case</span> <span class="token constant">SET_VISIBILITY_FILTER</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token function">_extends</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">visibilityFilter</span><span class="token operator">:</span> action<span class="token punctuation">.</span>filter <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">default</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> state<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Now imagine that <a href=https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Object/assign><code>Object.assign</code></a> is orders of magnitude slower than the polyfilled <code>_extends</code> generated by Babel. In that case upgrading from a browser that doesn’t support <a href=https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Object/assign><code>Object.assign</code></a> to an ES2015 capable version of the browser would be a serious performance regression and probably hinder adoption of ES2015 in the wild.<p>This example also highlights another important drawback of transpilation: The generated code that is shipped to the user is usually considerably bigger than the ES2015+ code that the developer initially wrote. In the example above, the original code is 203 characters (176 bytes gzipped) whereas the generated code is 588 characters (367 bytes gzipped). That’s already a factor of two increase in size. Let’s look at another example from the <a href=https://github.com/tc39/proposal-async-iteration>async iterators</a> proposal:<pre class=language-js><code class=language-js><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">readLines</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fileOpen</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">yield</span> <span class="token keyword">await</span> file<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span><br>    <span class="token keyword">await</span> file<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Babel translates these 187 characters (150 bytes gzipped) into a whopping 2987 characters (971 bytes gzipped) of ES5 code, not even counting the <a href=https://babeljs.io/docs/plugins/transform-regenerator/ >regenerator runtime</a> that is required as an additional dependency:<pre class=language-js><code class=language-js><span class="token string">'use strict'</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> <span class="token function function-variable">_asyncGenerator</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">function</span> <span class="token function">AwaitValue</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">AsyncGenerator</span><span class="token punctuation">(</span><span class="token parameter">gen</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> front<span class="token punctuation">,</span> back<span class="token punctuation">;</span><br><br>    <span class="token keyword">function</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token punctuation">{</span><br>          <span class="token literal-property property">key</span><span class="token operator">:</span> key<span class="token punctuation">,</span><br>          <span class="token literal-property property">arg</span><span class="token operator">:</span> arg<span class="token punctuation">,</span><br>          <span class="token literal-property property">resolve</span><span class="token operator">:</span> resolve<span class="token punctuation">,</span><br>          <span class="token literal-property property">reject</span><span class="token operator">:</span> reject<span class="token punctuation">,</span><br>          <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token keyword">null</span><br>        <span class="token punctuation">}</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>back<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          back <span class="token operator">=</span> back<span class="token punctuation">.</span>next <span class="token operator">=</span> request<span class="token punctuation">;</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>          front <span class="token operator">=</span> back <span class="token operator">=</span> request<span class="token punctuation">;</span><br>          <span class="token function">resume</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">function</span> <span class="token function">resume</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">try</span> <span class="token punctuation">{</span><br>        <span class="token keyword">var</span> result <span class="token operator">=</span> gen<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">var</span> value <span class="token operator">=</span> result<span class="token punctuation">.</span>value<span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">AwaitValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token function">resume</span><span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token function">resume</span><span class="token punctuation">(</span><span class="token string">'throw'</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>          <span class="token function">settle</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>done <span class="token operator">?</span> <span class="token string">'return'</span> <span class="token operator">:</span> <span class="token string">'normal'</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">settle</span><span class="token punctuation">(</span><span class="token string">'throw'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">function</span> <span class="token function">settle</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">case</span> <span class="token string">'return'</span><span class="token operator">:</span><br>          front<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>            <span class="token literal-property property">value</span><span class="token operator">:</span> value<span class="token punctuation">,</span><br>            <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span><br>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token keyword">break</span><span class="token punctuation">;</span><br>        <span class="token keyword">case</span> <span class="token string">'throw'</span><span class="token operator">:</span><br>          front<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token keyword">break</span><span class="token punctuation">;</span><br>        <span class="token keyword">default</span><span class="token operator">:</span><br>          front<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>            <span class="token literal-property property">value</span><span class="token operator">:</span> value<span class="token punctuation">,</span><br>            <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span><br>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token keyword">break</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      front <span class="token operator">=</span> front<span class="token punctuation">.</span>next<span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>front<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">resume</span><span class="token punctuation">(</span>front<span class="token punctuation">.</span>key<span class="token punctuation">,</span> front<span class="token punctuation">.</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        back <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>_invoke <span class="token operator">=</span> send<span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> gen<span class="token punctuation">.</span>return <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>return <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Symbol <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&&</span> Symbol<span class="token punctuation">.</span>asyncIterator<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token class-name">AsyncGenerator</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>asyncIterator<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token class-name">AsyncGenerator</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function function-variable">next</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_invoke</span><span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token class-name">AsyncGenerator</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function function-variable">throw</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_invoke</span><span class="token punctuation">(</span><span class="token string">'throw'</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token class-name">AsyncGenerator</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function function-variable">return</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_invoke</span><span class="token punctuation">(</span><span class="token string">'return'</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">{</span><br>    <span class="token function function-variable">wrap</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AsyncGenerator</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token function function-variable">await</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AwaitValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> <span class="token function function-variable">readLines</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> _ref <span class="token operator">=</span> _asyncGenerator<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>regeneratorRuntime<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">_callee</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> file<span class="token punctuation">;</span><br>    <span class="token keyword">return</span> regeneratorRuntime<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">_callee$</span><span class="token punctuation">(</span><span class="token parameter">_context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>_context<span class="token punctuation">.</span>prev <span class="token operator">=</span> _context<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span><br>            _context<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><br>            <span class="token keyword">return</span> _asyncGenerator<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token function">fileOpen</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>          <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span><br>            file <span class="token operator">=</span> _context<span class="token punctuation">.</span>sent<span class="token punctuation">;</span><br>            _context<span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><br><br>          <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>              _context<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span><br>              <span class="token keyword">break</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br><br>            _context<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span><br>            <span class="token keyword">return</span> _asyncGenerator<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>          <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span><br>            _context<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span><br>            <span class="token keyword">return</span> _context<span class="token punctuation">.</span>sent<span class="token punctuation">;</span><br><br>          <span class="token keyword">case</span> <span class="token number">9</span><span class="token operator">:</span><br>            _context<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span><br>            <span class="token keyword">break</span><span class="token punctuation">;</span><br><br>          <span class="token keyword">case</span> <span class="token number">11</span><span class="token operator">:</span><br>            _context<span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span><br>            _context<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span><br>            <span class="token keyword">return</span> _asyncGenerator<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>          <span class="token keyword">case</span> <span class="token number">14</span><span class="token operator">:</span><br>            <span class="token keyword">return</span> _context<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>          <span class="token keyword">case</span> <span class="token number">15</span><span class="token operator">:</span><br>          <span class="token keyword">case</span> <span class="token string">'end'</span><span class="token operator">:</span><br>            <span class="token keyword">return</span> _context<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span> _callee<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">readLines</span><span class="token punctuation">(</span><span class="token parameter">_x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token function">_ref</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This is a <strong>650%</strong> increase in size (the generic <code>_asyncGenerator</code> function might be shareable depending on how you bundle your code, so you can amortize some of that cost across multiple uses of async iterators). We don’t think it’s viable to ship only code transpiled to ES5 long-term, as the increase in size will not only affect download time/cost, but will also add additional overhead to parsing and compilation. If we really want to drastically improve page load and snappiness of modern web applications, especially on mobile devices, we have to encourage developers to not only use ES2015+ when writing code, but also to ship that instead of transpiling to ES5. Only deliver fully transpiled bundles to legacy browsers that don’t support ES2015. For VM implementors, this vision means we need to support ES2015+ features natively <strong>and</strong> provide reasonable performance.<h2 id=measurement-methodology>Measurement methodology <a href=#measurement-methodology class=bookmark>#</a></h2><p>As described above, absolute performance of ES2015+ features is not really an issue at this point. Instead the highest priority currently is to ensure that performance of ES2015+ features is on par with their naive ES5 and even more importantly, with the version generated by Babel. Conveniently there was already a project called <a href=https://github.com/kpdecker/six-speed>SixSpeed</a> by <a href=http://www.incaseofstairs.com/ >Kevin Decker</a>, that accomplishes more or less exactly what we needed: a performance comparison of ES2015 features vs. naive ES5 vs. code generated by transpilers.<figure><img alt="" height=1103 loading=lazy src=/_img/high-performance-es2015/sixspeed.png width=1261><figcaption>The SixSpeed benchmark</figcaption></figure><p>So we decided to take that as the basis for our initial ES2015+ performance work. We <a href=https://fhinkel.github.io/six-speed/ >forked SixSpeed</a> and added a couple of benchmarks. We focused on the most serious regressions first, i.e. line items where slowdown from naive ES5 to recommended ES2015+ version was above 2x, because our fundamental assumption is that the naive ES5 version will be at least as fast as the somewhat spec-compliant version that Babel generates.<h2 id=a-modern-architecture-for-a-modern-language>A modern architecture for a modern language <a href=#a-modern-architecture-for-a-modern-language class=bookmark>#</a></h2><p>In the past V8’s had difficulties optimizing the kind of language features that are found in ES2015+. For example, it never became feasible to add exception handling (i.e. try/catch/finally) support to Crankshaft, V8’s classic optimizing compiler. This meant V8’s ability to optimize an ES6 feature like for...of, which essentially has an implicit finally clause, was limited. Crankshaft’s limitations and the overall complexity of adding new language features to full-codegen, V8’s baseline compiler, made it inherently difficult to ensure new ES features were added and optimized in V8 as quickly as they were standardized.<p>Fortunately, Ignition and TurboFan (<a href=/blog/test-the-future>V8’s new interpreter and compiler pipeline</a>), were designed to support the entire JavaScript language from the beginning, including advanced control flow, exception handling, and most recently <code>for</code>-<code>of</code> and destructuring from ES2015. The tight integration of the architecture of Ignition and TurboFan make it possible to quickly add new features and to optimize them fast and incrementally.<p>Many of the improvements we achieved for modern language features were only feasible with the new Ignition/TurboFan pipeline. Ignition and TurboFan proved especially critical to optimizing generators and async functions. Generators had long been supported by V8, but were not optimizable due to control flow limitations in Crankshaft. Async functions are essentially sugar on top of generators, so they fall into the same category. The new compiler pipeline leverages Ignition to make sense of the AST and generate bytecodes which de-sugar complex generator control flow into simpler local-control flow bytecodes. TurboFan can more easily optimize the resulting bytecodes since it doesn’t need to know anything specific about generator control flow, just how to save and restore a function’s state on yields.<figure><img alt="" height=442 loading=lazy src=/_img/high-performance-es2015/generators.svg width=800><figcaption>How JavaScript generators are represented in Ignition and TurboFan</figcaption></figure><h2 id=state-of-the-union>State of the union <a href=#state-of-the-union class=bookmark>#</a></h2><p>Our short-term goal was to reach less than 2× slowdown on average as soon as possible. We started by looking at the worst test first, and from Chrome 54 to Chrome 58 (Canary) we managed to reduce the number of tests with slowdown above 2× from 16 to 8, and at the same time reduce the worst slowdown from 19× in Chrome 54 to just 6× in Chrome 58 (Canary). We also significantly reduced the average and median slowdown during that period:<figure><img alt="" height=497 loading=lazy src=/_img/high-performance-es2015/slowdown.svg width=804><figcaption>Slowdown of ES2015+ compared to native ES5 equivalent</figcaption></figure><p>You can see a clear trend towards parity of ES2015+ and ES5. On average we improved performance relative to ES5 by over 47%. Here are some highlights that we addressed since Chrome 54.<figure><img alt="" height=591 loading=lazy src=/_img/high-performance-es2015/comparison.svg width=845><figcaption>ES2015+ performance compared to naive ES5 equivalent</figcaption></figure><p>Most notably we improved performance of new language constructs that are based on iteration, like the spread operator, destructuring and <code>for</code>-<code>of</code> loops. For example, using array destructuring:<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> <span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span><br>  <span class="token keyword">return</span> c<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>…is now as fast as the naive ES5 version:<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> c <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> c<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>…and a lot faster (and shorter) than the Babel-generated code:<pre class=language-js><code class=language-js><span class="token string">'use strict'</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> <span class="token function function-variable">_slicedToArray</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">function</span> <span class="token function">sliceIterator</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> _arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">var</span> _n <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>    <span class="token keyword">var</span> _d <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>    <span class="token keyword">var</span> _e <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> _i <span class="token operator">=</span> arr<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _s<span class="token punctuation">;</span> <span class="token operator">!</span><span class="token punctuation">(</span>_n <span class="token operator">=</span> <span class="token punctuation">(</span>_s <span class="token operator">=</span> _i<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span> _n <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        _arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>_s<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&&</span> _arr<span class="token punctuation">.</span>length <span class="token operator">===</span> i<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      _d <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>      _e <span class="token operator">=</span> err<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span><br>      <span class="token keyword">try</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_n <span class="token operator">&&</span> _i<span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> _i<span class="token punctuation">[</span><span class="token string">'return'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>_d<span class="token punctuation">)</span> <span class="token keyword">throw</span> _e<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> _arr<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> arr<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Symbol<span class="token punctuation">.</span>iterator <span class="token keyword">in</span> <span class="token function">Object</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> <span class="token function">sliceIterator</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Invalid attempt to destructure non-iterable instance'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> _data <span class="token operator">=</span> data<span class="token punctuation">,</span><br>      _data2 <span class="token operator">=</span> <span class="token function">_slicedToArray</span><span class="token punctuation">(</span>_data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      c <span class="token operator">=</span> _data2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> c<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>You can check out the <a href=https://docs.google.com/presentation/d/1wiiZeRQp8-sXDB9xXBUAGbaQaWJC84M5RNxRyQuTmhk>High-Speed ES2015</a> talk we gave at the last <a href=http://www.mnug.de/ >Munich NodeJS User Group</a> meetup for additional details:<p>We are committed to continue improving the performance of ES2015+ features. In case you are interested in the nitty-gritty details please have a look at V8’s <a href=https://docs.google.com/document/d/1EA9EbfnydAmmU_lM8R_uEMQ-U_v4l9zulePSBkeYWmY>ES2015 and beyond performance plan</a>.</div><footer><div><picture><source srcset="/_img/avatars/benedikt-meurer.avif, /_img/avatars/benedikt-meurer@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/benedikt-meurer.jpg width=96 srcset="/_img/avatars/benedikt-meurer@2x.jpg 2x"></picture><p>作者：Benedikt Meurer <a href=https://twitter.com/bmeurer>@bmeurer</a>, ECMAScript Performance Engineer.</div></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/blog/high-performance-es2015>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/blog/high-performance-es2015.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>