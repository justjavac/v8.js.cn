<!doctype html><html lang=zh-CN><meta charset=utf-8><title>V8 release v6.5 · V8</title><meta content="width=device-width" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=" js"</script><meta content="V8 v6.5 adds support for streaming WebASsembly compilation and includes a new “untrusted code mode”." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li><a href=/tools/ >工具</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>V8 release v6.5</h1><p class=meta>发布时间 <time datetime="2018-02-01 13:33:37" itemprop=datePublished title="2018-02-01 13:33:37">2018-02-01</time> · 标签： <a href=/blog/tags/release/ class=tag>release</a></header><div itemprop=articleBody><p>Every six weeks, we create a new branch of V8 as part of our <a href=/docs/release-process>release process</a>. Each version is branched from V8’s Git master immediately before a Chrome Beta milestone. Today we’re pleased to announce our newest branch, <a href=https://chromium.googlesource.com/v8/v8.git/+log/branch-heads/6.5>V8 version 6.5</a>, which is in beta until its release in coordination with Chrome 65 Stable in several weeks. V8 v6.5 is filled with all sorts of developer-facing goodies. This post provides a preview of some of the highlights in anticipation of the release.<h2 id=untrusted-code-mode>Untrusted code mode <a href=#untrusted-code-mode class=bookmark>#</a></h2><p>In response to the latest speculative side-channel attack called Spectre, V8 introduced an <a href=/docs/untrusted-code-mitigations>untrusted code mode</a>. If you embed V8, consider leveraging this mode in case your application processes user-generated, not-trustworthy code. Please note that the mode is enabled by default, including in Chrome.<h2 id=streaming-compilation-for-webassembly-code>Streaming compilation for WebAssembly code <a href=#streaming-compilation-for-webassembly-code class=bookmark>#</a></h2><p>The WebAssembly API provides a special function to support <a href=https://developers.google.com/web/updates/2018/04/loading-wasm>streaming compilation</a> in combination with the <code>fetch()</code> API:<pre class=language-js><code class=language-js><span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">await</span> WebAssembly<span class="token punctuation">.</span><span class="token function">compileStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'foo.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This API has been available since V8 v6.1 and Chrome 61, although the initial implementation didn’t actually use streaming compilation. However, with V8 v6.5 and Chrome 65 we take advantage of this API and compile WebAssembly modules already while we are still downloading the module bytes. As soon as we download all bytes of a single function, we pass the function to a background thread to compile it.<p>Our measurements show that with this API, the WebAssembly compilation in Chrome 65 can keep up with up to 50 Mbit/s download speed on high-end machines. This means that if you download WebAssembly code with 50 Mbit/s, compilation of that code finishes as soon as the download finishes.<p>For the graph below we measure the time it takes to download and compile a WebAssembly module with 67 MB and about 190,000 functions. We do the measurements with 25 Mbit/s, 50 Mbit/s, and 100 Mbit/s download speed.<figure><img alt="" height=371 loading=lazy src=/_img/v8-release-65/wasm-streaming-compilation.svg width=600></figure><p>When the download time is longer than the compile time of the WebAssembly module, e.g. in the graph above with 25 Mbit/s and 50 Mbit/s, then <code>WebAssembly.compileStreaming()</code> finishes compilation almost immediately after the last bytes are downloaded.<p>When the download time is shorter than the compile time, then <code>WebAssembly.compileStreaming()</code> takes about as long as it takes to compile the WebAssembly module without downloading the module first.<h2 id=speed>Speed <a href=#speed class=bookmark>#</a></h2><p>We continued to work on widening the fast-path of JavaScript builtins in general, adding a mechanism to detect and prevent a ruinous situation called a “deoptimization loop.” This occurs when your optimized code deoptimizes, and there is <em>no way to learn what went wrong</em>. In such scenarios, TurboFan just keeps trying to optimize, finally giving up after about 30 attempts. This would happen if you did something to alter the shape of the array in the callback function of any of our second order array builtins. For example, changing the <code>length</code> of the array — in V8 v6.5, we note when that happens, and stop inlining the array builtin called at that site on future optimization attempts.<p>We also widened the fast-path by inlining many builtins that were formerly excluded because of a side-effect between the load of the function to call and the call itself, for example a function call. And <code>String.prototype.indexOf</code> got a <a href="https://bugs.chromium.org/p/v8/issues/detail?id=6270">10× performance improvement in function calls</a>.<p>In V8 v6.4, we’d inlined support for <code>Array.prototype.forEach</code>, <code>Array.prototype.map</code>, and <code>Array.prototype.filter</code>. In V8 v6.5 we’ve added inlining support for:<ul><li><code>Array.prototype.reduce</code><li><code>Array.prototype.reduceRight</code><li><code>Array.prototype.find</code><li><code>Array.prototype.findIndex</code><li><code>Array.prototype.some</code><li><code>Array.prototype.every</code></ul><p>Furthermore, we’ve widened the fast path on all these builtins. At first we would bail out on seeing arrays with floating-point numbers, or (even more bailing out) <a href=/blog/elements-kinds>if the arrays had “holes” in them</a>, e.g. <code>[3, 4.5, , 6]</code>. Now, we handle holey floating-point arrays everywhere except in <code>find</code> and <code>findIndex</code>, where the spec requirement to convert holes into <code>undefined</code> throws a monkey-wrench into our efforts (<em>for now…!</em>).<p>The following image shows the improvement delta compared to V8 v6.4 in our inlined builtins, broken down into integer arrays, double arrays, and double arrays with holes. Time is in milliseconds.<figure><img alt="" height=494 loading=lazy src=/_img/v8-release-65/performance-improvements.svg width=799><figcaption>Performance improvements since V8 v6.4</figcaption></figure><h2 id=v8-api>V8 API <a href=#v8-api class=bookmark>#</a></h2><p>Please use <code>git log branch-heads/6.4..branch-heads/6.5 include/v8.h</code> to get a list of the API changes.<p>Developers with an <a href=/docs/source-code#using-git>active V8 checkout</a> can use <code>git checkout -b 6.5 -t branch-heads/6.5</code> to experiment with the new features in V8 v6.5. Alternatively you can <a href=https://www.google.com/chrome/browser/beta.html>subscribe to Chrome’s Beta channel</a> and try the new features out yourself soon.</div><footer><div><p>作者：the V8 team.</div><a href=https://twitter.com/v8js/status/959174292406640640 class=retweet>Retweet this article!</a></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/blog/v8-release-65>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/blog/v8-release-65.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>