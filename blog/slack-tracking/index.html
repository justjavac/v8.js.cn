<!doctype html><html lang=zh-CN><meta charset=utf-8><title>Slack tracking in V8 · V8</title><meta content="width=device-width" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=" js"</script><meta content="A detailed look into the V8 slack tracking mechanism." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li><a href=/tools/ >工具</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>Slack tracking in V8</h1><p class=meta>发布时间 <time datetime="2020-09-24 14:00:00" itemprop=datePublished title="2020-09-24 14:00:00">2020-09-24</time> · 标签： <a href=/blog/tags/internals/ class=tag>internals</a></header><div itemprop=articleBody><p>Slack tracking is a way to give new objects an initial size that is <strong>larger than what they may actually use</strong>, so they can have new properties added quickly. And then, after some period of time, to <strong>magically return that unused space to the system</strong>. Neat, huh?<p>It’s especially useful because JavaScript doesn’t have static classes. The system can never see “at a glance” how many properties you have. The engine experiences them one by one. So when you read:<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">Peak</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> m1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Matterhorn'</span><span class="token punctuation">,</span> <span class="token number">4478</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>You might think the engine has all it needs to perform well — you’ve told it the object has two properties, after all. However, V8 really has no idea what will come next. This object <code>m1</code> could be passed to another function that adds 10 more properties to it. Slack tracking comes out of this need to be responsive to whatever comes next in an environment without static compilation to infer overall structure. It’s like many other mechanisms in V8, whose basis is only things you can generally say about execution, like:<ul><li>Most objects die soon, few live long — the garbage collection “generational hypothesis”.<li>The program does indeed have an organizational structure — we build <a href=https://mathiasbynens.be/notes/shapes-ics>shapes or “hidden classes”</a> (we call these <strong>maps</strong> in V8) into the objects we see the programmer uses because we believe they will be useful. <em>BTW, <a href=/blog/fast-properties>Fast Properties in V8</a> is a great post with interesting details about maps and property access.</em><li>Programs have an initialization state, when everything is new and it’s hard to tell what’s important. Later, the important classes and functions can be identified through their steady use — our feedback regime and compiler pipeline grow out of this idea.</ul><p>Finally, and most importantly, the runtime environment must be very fast, otherwise we’re just philosophizing.<p>Now, V8 could simply store properties in a backing store attached to the main object. Unlike properties that live directly in the object, this backing store can grow indefinitely through copying and replacing the pointer. However the fastest access to a property comes by avoiding that indirection and looking at a fixed offset from the start of the object. Below, I show the layout of a plain ol’ JavaScript object in the V8 heap with two in-object properties. The first three words are standard in every object (a pointer to the map, to the properties backing store, and to the elements backing store). You can see that the object can’t “grow” because it’s hard up against the next object in the heap:<figure><img alt="" height=230 loading=lazy src=/_img/slack-tracking/property-layout.svg width=600></figure><div class=note><p><strong>Note:</strong> I left out the details of the property backing store because the only thing important about it for the moment is that it can be replaced at any time with a larger one. However, it too is an object on the V8 heap and has a map pointer like all objects that reside there.</div><p>So anyway, because of the performance provided by in-object properties, V8 is willing to give you extra space in each object, and <strong>slack tracking</strong> is the way it’s done. Eventually, you’ll settle down, stop adding new properties, and get down to the business of mining bitcoin or whatever.<p>How much “time” does V8 give you? Cleverly, it considers the number of times you’ve constructed a particular object. In fact, there is a counter in the map, and it’s initialized with one of the more mystical magic numbers in the system: <strong>seven</strong>.<p>Another question: how does V8 know how much extra space in the object body to provide? It actually gets a hint from the compilation process, which offers an estimated number of properties to start with. This calculation includes the number of properties from the prototype object, going up the chain of prototypes recursively. Finally, for good measure it adds <strong>eight</strong> more (another magic number!). You can see this in <code>JSFunction::CalculateExpectedNofProperties()</code>:<pre class=language-cpp><code class=language-cpp><span class="token keyword">int</span> <span class="token class-name">JSFunction</span><span class="token punctuation double-colon">::</span><span class="token function">CalculateExpectedNofProperties</span><span class="token punctuation">(</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">,</span><br>                                               Handle<span class="token operator">&lt;</span>JSFunction<span class="token operator">></span> function<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">int</span> expected_nof_properties <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span>PrototypeIterator <span class="token function">iter</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> function<span class="token punctuation">,</span> kStartAtReceiver<span class="token punctuation">)</span><span class="token punctuation">;</span><br>       <span class="token operator">!</span>iter<span class="token punctuation">.</span><span class="token function">IsAtEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token punctuation">.</span><span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    Handle<span class="token operator">&lt;</span>JSReceiver<span class="token operator">></span> current <span class="token operator">=</span><br>        PrototypeIterator<span class="token punctuation double-colon">::</span><span class="token generic-function"><span class="token function">GetCurrent</span><span class="token class-name generic"><span class="token operator">&lt;</span>JSReceiver<span class="token operator">></span></span></span><span class="token punctuation">(</span>iter<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>current<span class="token operator">-></span><span class="token function">IsJSFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span><br>    Handle<span class="token operator">&lt;</span>JSFunction<span class="token operator">></span> func <span class="token operator">=</span> <span class="token class-name">Handle</span><span class="token operator">&lt;</span>JSFunction<span class="token operator">></span><span class="token punctuation double-colon">::</span><span class="token function">cast</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// The super constructor should be compiled for the number of expected</span><br>    <span class="token comment">// properties to be available.</span><br>    Handle<span class="token operator">&lt;</span>SharedFunctionInfo<span class="token operator">></span> <span class="token function">shared</span><span class="token punctuation">(</span>func<span class="token operator">-></span><span class="token function">shared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isolate<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    IsCompiledScope <span class="token function">is_compiled_scope</span><span class="token punctuation">(</span>shared<span class="token operator">-></span><span class="token function">is_compiled_scope</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_compiled_scope<span class="token punctuation">.</span><span class="token function">is_compiled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span><br>        <span class="token class-name">Compiler</span><span class="token punctuation double-colon">::</span><span class="token function">Compile</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> Compiler<span class="token punctuation double-colon">::</span>CLEAR_EXCEPTION<span class="token punctuation">,</span><br>                          <span class="token operator">&</span>is_compiled_scope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">DCHECK</span><span class="token punctuation">(</span>shared<span class="token operator">-></span><span class="token function">is_compiled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">int</span> count <span class="token operator">=</span> shared<span class="token operator">-></span><span class="token function">expected_nof_properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token comment">// Check that the estimate is sensible.</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>expected_nof_properties <span class="token operator">&lt;=</span> JSObject<span class="token punctuation double-colon">::</span>kMaxInObjectProperties <span class="token operator">-</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        expected_nof_properties <span class="token operator">+=</span> count<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> JSObject<span class="token punctuation double-colon">::</span>kMaxInObjectProperties<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      <span class="token comment">// In case there was a compilation error proceed iterating in case there</span><br>      <span class="token comment">// will be a builtin function in the prototype chain that requires</span><br>      <span class="token comment">// certain number of in-object properties.</span><br>      <span class="token keyword">continue</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br>  <span class="token comment">// In-object slack tracking will reclaim redundant inobject space</span><br>  <span class="token comment">// later, so we can afford to adjust the estimate generously,</span><br>  <span class="token comment">// meaning we over-allocate by at least 8 slots in the beginning.</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>expected_nof_properties <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    expected_nof_properties <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>expected_nof_properties <span class="token operator">></span> JSObject<span class="token punctuation double-colon">::</span>kMaxInObjectProperties<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      expected_nof_properties <span class="token operator">=</span> JSObject<span class="token punctuation double-colon">::</span>kMaxInObjectProperties<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">return</span> expected_nof_properties<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>Let’s have a look at our object <code>m1</code> from before:<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">Peak</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> m1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Matterhorn'</span><span class="token punctuation">,</span> <span class="token number">4478</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>By the calculation in <code>JSFunction::CalculateExpectedNofProperties</code> and our <code>Peak()</code> function, we should have 2 in-object properties, and thanks to slack tracking, another 8 extra. We can print <code>m1</code> with <code>%DebugPrint()</code> (<em>this handy function exposes the map structure. You can use it by running <code>d8</code> with the flag <code>--allow-natives-syntax</code></em>):<pre><code>> %DebugPrint(m1);
DebugPrint: 0x49fc866d: [JS_OBJECT_TYPE]
 - map: 0x58647385 &lt;Map(HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x49fc85e9 &lt;Object map = 0x58647335>
 - elements: 0x28c821a1 &lt;FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x28c821a1 &lt;FixedArray[0]> {
    0x28c846f9: [String] in ReadOnlySpace: #name: 0x5e412439 &lt;String[10]: #Matterhorn> (const data field 0)
    0x5e412415: [String] in OldSpace: #height: 4478 (const data field 1)
 }
  0x58647385: [Map]
 - type: JS_OBJECT_TYPE
 - instance size: 52
 - inobject properties: 10
 - elements kind: HOLEY_ELEMENTS
 - unused property fields: 8
 - enum length: invalid
 - stable_map
 - back pointer: 0x5864735d &lt;Map(HOLEY_ELEMENTS)>
 - prototype_validity cell: 0x5e4126fd &lt;Cell value= 0>
 - instance descriptors (own) #2: 0x49fc8701 &lt;DescriptorArray[2]>
 - prototype: 0x49fc85e9 &lt;Object map = 0x58647335>
 - constructor: 0x5e4125ed &lt;JSFunction Peak (sfi = 0x5e4124dd)>
 - dependent code: 0x28c8212d &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)>
 - construction counter: 6
</code></pre><p>Note the instance size of the object is 52. Object layout in V8 is like so:<table><thead><tr><th>word<th>what<tbody><tr><td>0<td>the map<tr><td>1<td>pointer to the properties array<tr><td>2<td>pointer to the elements array<tr><td>3<td>in-object field 1 (pointer to string <code>"Matterhorn"</code>)<tr><td>4<td>in-object field 2 (integer value <code>4478</code>)<tr><td>5<td>unused in-object field 3<tr><td>…<td>…<tr><td>12<td>unused in-object field 10</table><p>Pointer size is 4 in this 32-bit binary, so we’ve got those 3 initial words that every ordinary JavaScript object has, and then 10 extra words in the object. It tells us above, helpfully, that there are 8 “unused property fields”. So, we are experiencing slack tracking. Our objects are bloated, greedy consumers of precious bytes!<p>How do we slim down? We use the construction counter field in the map. We reach zero and then decide we are done with slack tracking. However, if you construct more objects, you won’t see the counter above decreasing. Why?<p>Well, it’s because the map displayed above is not “the” map for a <code>Peak</code> object. It’s only a leaf map in a chain of maps descending from the <strong>initial map</strong> that the <code>Peak</code> object is given before executing the constructor code.<p>How to find the initial map? Happily, the function <code>Peak()</code> has a pointer to it. It’s the construction counter in the initial map that we use to control slack tracking:<pre><code>> %DebugPrint(Peak);
d8> %DebugPrint(Peak)
DebugPrint: 0x31c12561: [Function] in OldSpace
 - map: 0x2a2821f5 &lt;Map(HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x31c034b5 &lt;JSFunction (sfi = 0x36108421)>
 - elements: 0x28c821a1 &lt;FixedArray[0]> [HOLEY_ELEMENTS]
 - function prototype: 0x37449c89 &lt;Object map = 0x2a287335>
 - initial_map: 0x46f07295 &lt;Map(HOLEY_ELEMENTS)>   // Here's the initial map.
 - shared_info: 0x31c12495 &lt;SharedFunctionInfo Peak>
 - name: 0x31c12405 &lt;String[4]: #Peak>
…

d8> // %DebugPrintPtr allows you to print the initial map.
d8> %DebugPrintPtr(0x46f07295)
DebugPrint: 0x46f07295: [Map]
 - type: JS_OBJECT_TYPE
 - instance size: 52
 - inobject properties: 10
 - elements kind: HOLEY_ELEMENTS
 - unused property fields: 10
 - enum length: invalid
 - back pointer: 0x28c02329 &lt;undefined>
 - prototype_validity cell: 0x47f0232d &lt;Cell value= 1>
 - instance descriptors (own) #0: 0x28c02135 &lt;DescriptorArray[0]>
 - transitions #1: 0x46f0735d &lt;Map(HOLEY_ELEMENTS)>
     0x28c046f9: [String] in ReadOnlySpace: #name:
         (transition to (const data field, attrs: [WEC]) @ Any) ->
             0x46f0735d &lt;Map(HOLEY_ELEMENTS)>
 - prototype: 0x5cc09c7d &lt;Object map = 0x46f07335>
 - constructor: 0x21e92561 &lt;JSFunction Peak (sfi = 0x21e92495)>
 - dependent code: 0x28c0212d &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)>
 - construction counter: 5
</code></pre><p>See how the construction counter is decremented to 5? If you’d like to find the initial map from the two-property map we showed above, you can follow its back pointer with the help of <code>%DebugPrintPtr()</code> until you reach a map with <code>undefined</code> in the back pointer slot. That will be this map above.<p>Now, a map tree grows from the initial map, with a branch for each property added from that point. We call these branches <em>transitions</em>. In the above printout of the initial map, do you see the transition to the next map with the label “name”? The whole map tree thus far looks like this:<figure><img alt="" height=340 loading=lazy src=/_img/slack-tracking/root-map-1.svg width=600><figcaption>(X, Y, Z) means (instance size, number of in-object properties, number of unused properties).</figcaption></figure><p>These transitions based on property names are how the <a href="https://www.google.com/search?q=blind+mole&tbm=isch">“blind mole”</a>" of JavaScript builds its maps behind you. This initial map is also stored in the function <code>Peak</code>, so when it’s used as a constructor, that map can be used to set up the <code>this</code> object.<pre class=language-js><code class=language-js><span class="token keyword">const</span> m1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Matterhorn'</span><span class="token punctuation">,</span> <span class="token number">4478</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> m2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Mont Blanc'</span><span class="token punctuation">,</span> <span class="token number">4810</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> m3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Zinalrothorn'</span><span class="token punctuation">,</span> <span class="token number">4221</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> m4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Wendelstein'</span><span class="token punctuation">,</span> <span class="token number">1838</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> m5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Zugspitze'</span><span class="token punctuation">,</span> <span class="token number">2962</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> m6 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Watzmann'</span><span class="token punctuation">,</span> <span class="token number">2713</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> m7 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Eiger'</span><span class="token punctuation">,</span> <span class="token number">3970</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The cool thing here is that after creating <code>m7</code>, running <code>%DebugPrint(m1)</code> again produces a marvellous new result:<pre><code>DebugPrint: 0x5cd08751: [JS_OBJECT_TYPE]
 - map: 0x4b387385 &lt;Map(HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x5cd086cd &lt;Object map = 0x4b387335>
 - elements: 0x586421a1 &lt;FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x586421a1 &lt;FixedArray[0]> {
    0x586446f9: [String] in ReadOnlySpace: #name:
        0x51112439 &lt;String[10]: #Matterhorn> (const data field 0)
    0x51112415: [String] in OldSpace: #height:
        4478 (const data field 1)
 }
0x4b387385: [Map]
 - type: JS_OBJECT_TYPE
 - instance size: 20
 - inobject properties: 2
 - elements kind: HOLEY_ELEMENTS
 - unused property fields: 0
 - enum length: invalid
 - stable_map
 - back pointer: 0x4b38735d &lt;Map(HOLEY_ELEMENTS)>
 - prototype_validity cell: 0x511128dd &lt;Cell value= 0>
 - instance descriptors (own) #2: 0x5cd087e5 &lt;DescriptorArray[2]>
 - prototype: 0x5cd086cd &lt;Object map = 0x4b387335>
 - constructor: 0x511127cd &lt;JSFunction Peak (sfi = 0x511125f5)>
 - dependent code: 0x5864212d &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)>
 - construction counter: 0
</code></pre><p>Our instance size is now 20, which is 5 words:<table><thead><tr><th>word<th>what<tbody><tr><td>0<td>the map<tr><td>1<td>pointer to the properties array<tr><td>2<td>pointer to the elements array<tr><td>3<td>name<tr><td>4<td>height</table><p>You’ll wonder how this happened. After all, if this object is laid out in memory, and used to have 10 properties, how can the system tolerate these 8 words laying around with no one to own them? It’s true that we never filled them with anything interesting — maybe that can help us.<p>If you wonder why I’m worried about leaving these words laying around, there is some background you need to know about the garbage collector. Objects are laid out one after the other, and the V8 garbage collector keeps track of things in that memory by walking over it again and again. Starting at the first word in memory, it expects to find a pointer to a map. It reads the instance size from the map and then knows how far to step forward to the next valid object. For some classes it has to additionally compute a length, but that’s all there is to it.<figure><img alt="" height=80 loading=lazy src=/_img/slack-tracking/gc-heap-1.svg width=600></figure><p>In the diagram above, the red boxes are the <strong>maps</strong>, and the white boxes the words that fill out the instance size of the object. The garbage collector can “walk” the heap by hopping from map to map.<p>So what happens if the map suddenly changes it’s instance size? Now when the GC (garbage collector) walks the heap it will find itself looking at a word that it didn’t see before. In the case of our <code>Peak</code> class, we change from taking up 13 words to only 5 (I colored the “unused property” words yellow):<figure><img alt="" height=60 loading=lazy src=/_img/slack-tracking/gc-heap-2.svg width=600></figure><figure><img alt="" height=60 loading=lazy src=/_img/slack-tracking/gc-heap-3.svg width=600></figure><p>We can deal with this if we cleverly initialize those unused properties with a <strong>“filler” map of instance size 4</strong>. This way, the GC will lightly walk over them once they are exposed to the traversal.<figure><img alt="" height=60 loading=lazy src=/_img/slack-tracking/gc-heap-4.svg width=600></figure><p>This is expressed in the code in <code>Factory::InitializeJSObjectBody()</code>:<pre class=language-cpp><code class=language-cpp><span class="token keyword">void</span> <span class="token class-name">Factory</span><span class="token punctuation double-colon">::</span><span class="token function">InitializeJSObjectBody</span><span class="token punctuation">(</span>Handle<span class="token operator">&lt;</span>JSObject<span class="token operator">></span> obj<span class="token punctuation">,</span> Handle<span class="token operator">&lt;</span>Map<span class="token operator">></span> map<span class="token punctuation">,</span><br>                                     <span class="token keyword">int</span> start_offset<span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>  <span class="token comment">// &lt;lines removed></span><br><br>  <span class="token keyword">bool</span> in_progress <span class="token operator">=</span> map<span class="token operator">-></span><span class="token function">IsInobjectSlackTrackingInProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  Object filler<span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>in_progress<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    filler <span class="token operator">=</span> <span class="token operator">*</span><span class="token function">one_pointer_filler_map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    filler <span class="token operator">=</span> <span class="token operator">*</span><span class="token function">undefined_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  obj<span class="token operator">-></span><span class="token function">InitializeBody</span><span class="token punctuation">(</span><span class="token operator">*</span>map<span class="token punctuation">,</span> start_offset<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token function">undefined_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filler<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>in_progress<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    map<span class="token operator">-></span><span class="token function">FindRootMap</span><span class="token punctuation">(</span><span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">InobjectSlackTrackingStep</span><span class="token punctuation">(</span><span class="token function">isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// &lt;lines removed></span><br><span class="token punctuation">}</span></code></pre><p>And so this is slack tracking in action. For each class you create, you can expect it to take up more memory for a while, but on the 7th instantiation we “call it good” and expose the leftover space for the GC to see. These one-word objects have no owners — that is, nobody points to them — so when a collection occurs they are freed up and living objects may be compacted to save space.<p>The diagram below reflects that slack tracking is <strong>finished</strong> for this initial map. Note that the instance size is now 20 (5 words: the map, the properties and elements arrays, and 2 more slots). Slack tracking respects the whole chain from the initial map. That is, if a descendent of the initial map ends up using all 10 of those initial extra properties, then the initial map keeps them, marking them as unused:<figure><img alt="" height=340 loading=lazy src=/_img/slack-tracking/root-map-2.svg width=600><figcaption>(X, Y, Z) means (instance size, number of in-object properties, number of unused properties).</figcaption></figure><p>Now that slack tracking is finished, what happens if we add another property to one of these <code>Peak</code> objects?<pre class=language-js><code class=language-js>m1<span class="token punctuation">.</span>country <span class="token operator">=</span> <span class="token string">'Switzerland'</span><span class="token punctuation">;</span></code></pre><p>V8 has to go into the properties backing store. We end up with the following object layout:<table><thead><tr><th>word<th>value<tbody><tr><td>0<td>map<tr><td>1<td>pointer to a properties backing store<tr><td>2<td>pointer to elements (empty array)<tr><td>3<td>pointer to string <code>"Matterhorn"</code><tr><td>4<td><code>4478</code></table><p>The properties backing store then looks like this:<table><thead><tr><th>word<th>value<tbody><tr><td>0<td>map<tr><td>1<td>length (3)<tr><td>2<td>pointer to string <code>"Switzerland"</code><tr><td>3<td><code>undefined</code><tr><td>4<td><code>undefined</code><tr><td>5<td><code>undefined</code></table><p>We have those extra <code>undefined</code> values there in case you decide to add more properties. We kind of think you might, based on your behavior so far!<h2 id=optional-properties>Optional properties <a href=#optional-properties class=bookmark>#</a></h2><p>It may happen that you add properties in some cases only. Suppose if height is 4000 meters or more, you want to keep track of two additional properties, <code>prominence</code> and <code>isClimbed</code>:<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">Peak</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> height<span class="token punctuation">,</span> prominence<span class="token punctuation">,</span> isClimbed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>height <span class="token operator">>=</span> <span class="token number">4000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>prominence <span class="token operator">=</span> prominence<span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>isClimbed <span class="token operator">=</span> isClimbed<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>You add a few of these different variants:<pre class=language-js><code class=language-js><span class="token keyword">const</span> m1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Wendelstein'</span><span class="token punctuation">,</span> <span class="token number">1838</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> m2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Matterhorn'</span><span class="token punctuation">,</span> <span class="token number">4478</span><span class="token punctuation">,</span> <span class="token number">1040</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> m3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Zugspitze'</span><span class="token punctuation">,</span> <span class="token number">2962</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> m4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Mont Blanc'</span><span class="token punctuation">,</span> <span class="token number">4810</span><span class="token punctuation">,</span> <span class="token number">4695</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> m5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Watzmann'</span><span class="token punctuation">,</span> <span class="token number">2713</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> m6 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Zinalrothorn'</span><span class="token punctuation">,</span> <span class="token number">4221</span><span class="token punctuation">,</span> <span class="token number">490</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> m7 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span><span class="token string">'Eiger'</span><span class="token punctuation">,</span> <span class="token number">3970</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>In this case, objects <code>m1</code>, <code>m3</code>, <code>m5</code>, and <code>m7</code> have one map, and objects <code>m2</code>, <code>m4</code>, and <code>m6</code> have a map further down the chain of descendents from the initial map because of the additional properties. When slack tracking is finished for this map family, there are <strong>4</strong> in-object properties instead of <strong>2</strong> like before, because slack tracking makes sure to keep sufficient room for the maximum number of in-object properties used by any descendents in the tree of maps below the initial map.<p>Below shows the map family after running the code above, and of course, slack tracking is complete:<figure><img alt="" height=600 loading=lazy src=/_img/slack-tracking/root-map-3.svg width=600><figcaption>(X, Y, Z) means (instance size, number of in-object properties, number of unused properties).</figcaption></figure><h2 id=how-about-optimized-code%3F>How about optimized code? <a href=#how-about-optimized-code%3F class=bookmark>#</a></h2><p>Let’s compile some optimized code before slack tracking is finished. We’ll use a couple native syntax commands to force a optimized compile to happen before we finished slack tracking:<pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> a4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Peak</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> a4<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token operator">%</span><span class="token function">PrepareFunctionForOptimization</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> m1 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token string">'Wendelstein'</span><span class="token punctuation">,</span> <span class="token number">1838</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> m2 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token string">'Matterhorn'</span><span class="token punctuation">,</span> <span class="token number">4478</span><span class="token punctuation">,</span> <span class="token number">1040</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token operator">%</span><span class="token function">OptimizeFunctionOnNextCall</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">foo</span><span class="token punctuation">(</span><span class="token string">'Zugspitze'</span><span class="token punctuation">,</span> <span class="token number">2962</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>That should be enough to compile and run optimized code. We do something in TurboFan (the optimizing compiler) called <a href="https://source.chromium.org/chromium/chromium/src/+/master:v8/src/compiler/js-create-lowering.h;l=32;drc=ee9e7e404e5a3f75a3ca0489aaf80490f625ca27"><strong>Create Lowering</strong></a>, where we inline the allocation of objects. That means the native code we produce emits instructions to ask the GC for the instance size of the object to allocate and then carefully initialize those fields. However, this code would be invalid if slack tracking were to stop at some later point. What can we do about that?<p>Easy-peasy! We just end slack tracking early for this map family. This makes sense because normally — we wouldn’t compile an optimized function until thousands of objects have been created. So slack tracking <em>should</em> be finished. If it’s not, too bad! The object must not be that important anyway if fewer than 7 of them have been created by this point. (Normally, remember, we are only optimizing after the program ran for a long time.)<h3 id=compiling-on-a-background-thread>Compiling on a background thread <a href=#compiling-on-a-background-thread class=bookmark>#</a></h3><p>We can compile optimized code on the main thread, in which case we can get away with prematurely ending slack tracking with some calls to change the initial map because the world has been stopped. However, we do as much compilation as possible on a background thread. From this thread it would be dangerous to touch the initial map because it <em>might be changing on the main thread where JavaScript is running.</em> So our technique goes like this:<ol><li><strong>Guess</strong> that the instance size will be what it would be if you did stop slack tracking right now. Remember this size.<li>When the compilation is almost done, we return to the main thread where we can safely force completion of slack tracking if it wasn’t already done.<li>Check: is the instance size what we predicted? If so, <strong>we are good!</strong> If not, throw away the code object and try again later.</ol><p>If you’d like to see this in code, have a look at the class <a href="https://source.chromium.org/chromium/chromium/src/+/master:v8/src/compiler/compilation-dependencies.cc?q=InitialMapInstanceSizePredictionDependency&ss=chromium%2Fchromium%2Fsrc"><code>InitialMapInstanceSizePredictionDependency</code></a> and how it’s used in <code>js-create-lowering.cc</code> to create inline allocations. You’ll see that the <code>PrepareInstall()</code> method is called on the main thread, which forces completion of slack tracking. Then method <code>Install()</code> checks if our guess on the instance size held up.<p>Here is the optimized code with the inlined allocation. First you see communication with the GC, checking to see if we can just bump a pointer forward by the instance size and take that (this is called bump-pointer allocation). Then, we start filling in fields of the new object:<pre class=language-asm><code class=language-asm>…<br><span class="token number">43</span>  <span class="token keyword">mov</span> <span class="token register variable">ecx</span>,<span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">0x5dfa4</span><span class="token operator">]</span><br><span class="token number">49</span>  lea <span class="token register variable">edi</span>,<span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">0x1c</span><span class="token operator">]</span><br>4c  cmp <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">0x5dfa8</span><span class="token operator">]</span>,<span class="token register variable">edi</span>       <span class="token comment">;; hey GC, can we have 28 (0x1c) bytes please?</span><br><span class="token number">52</span>  jna <span class="token number">0x36ec4a5a</span>  <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0x11a</span><span class="token operator">></span><br><br><span class="token number">58</span>  lea <span class="token register variable">edi</span>,<span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">0x1c</span><span class="token operator">]</span><br>5b  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">0x5dfa4</span><span class="token operator">]</span>,<span class="token register variable">edi</span>       <span class="token comment">;; okay GC, we took it. KThxbye.</span><br><span class="token number">61</span>  add <span class="token register variable">ecx</span>,<span class="token number">0x1</span>                 <span class="token comment">;; hells yes. ecx is my new object.</span><br><span class="token number">64</span>  <span class="token keyword">mov</span> <span class="token register variable">edi</span>,<span class="token number">0x46647295</span>          <span class="token comment">;; object: 0x46647295 &lt;Map(HOLEY_ELEMENTS)></span><br><span class="token number">69</span>  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">-</span><span class="token number">0x1</span><span class="token operator">]</span>,<span class="token register variable">edi</span>           <span class="token comment">;; Store the INITIAL MAP.</span><br>6c  <span class="token keyword">mov</span> <span class="token register variable">edi</span>,<span class="token number">0x56f821a1</span>          <span class="token comment">;; object: 0x56f821a1 &lt;FixedArray[0]></span><br><span class="token number">71</span>  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">0x3</span><span class="token operator">]</span>,<span class="token register variable">edi</span>           <span class="token comment">;; Store the PROPERTIES backing store (empty)</span><br><span class="token number">74</span>  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">0x7</span><span class="token operator">]</span>,<span class="token register variable">edi</span>           <span class="token comment">;; Store the ELEMENTS backing store (empty)</span><br><span class="token number">77</span>  <span class="token keyword">mov</span> <span class="token register variable">edi</span>,<span class="token number">0x56f82329</span>          <span class="token comment">;; object: 0x56f82329 &lt;undefined></span><br>7c  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">0xb</span><span class="token operator">]</span>,<span class="token register variable">edi</span>           <span class="token comment">;; in-object property 1 &lt;-- undefined</span><br>7f  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">0xf</span><span class="token operator">]</span>,<span class="token register variable">edi</span>           <span class="token comment">;; in-object property 2 &lt;-- undefined</span><br><span class="token number">82</span>  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">0x13</span><span class="token operator">]</span>,<span class="token register variable">edi</span>          <span class="token comment">;; in-object property 3 &lt;-- undefined</span><br><span class="token number">85</span>  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">0x17</span><span class="token operator">]</span>,<span class="token register variable">edi</span>          <span class="token comment">;; in-object property 4 &lt;-- undefined</span><br><span class="token number">88</span>  <span class="token keyword">mov</span> <span class="token register variable">edi</span>,<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">0xc</span><span class="token operator">]</span>           <span class="token comment">;; retrieve argument {a1}</span><br>8b  test_w <span class="token register variable">edi</span>,<span class="token number">0x1</span><br><span class="token number">90</span>  jz <span class="token number">0x36ec4a6d</span>  <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0x12d</span><span class="token operator">></span><br><span class="token number">96</span>  <span class="token keyword">mov</span> <span class="token register variable">eax</span>,<span class="token number">0x4664735d</span>          <span class="token comment">;; object: 0x4664735d &lt;Map(HOLEY_ELEMENTS)></span><br>9b  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">-</span><span class="token number">0x1</span><span class="token operator">]</span>,<span class="token register variable">eax</span>           <span class="token comment">;; push the map forward</span><br>9e  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">0xb</span><span class="token operator">]</span>,<span class="token register variable">edi</span>           <span class="token comment">;; name = {a1}</span><br>a1  <span class="token keyword">mov</span> <span class="token register variable">eax</span>,<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">0x10</span><span class="token operator">]</span>          <span class="token comment">;; retrieve argument {a2}</span><br>a4  test <span class="token register variable">al</span>,<span class="token number">0x1</span><br>a6  jnz <span class="token number">0x36ec4a77</span>  <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0x137</span><span class="token operator">></span><br>ac  <span class="token keyword">mov</span> <span class="token register variable">edx</span>,<span class="token number">0x46647385</span>          <span class="token comment">;; object: 0x46647385 &lt;Map(HOLEY_ELEMENTS)></span><br>b1  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">-</span><span class="token number">0x1</span><span class="token operator">]</span>,<span class="token register variable">edx</span>           <span class="token comment">;; push the map forward</span><br>b4  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">0xf</span><span class="token operator">]</span>,<span class="token register variable">eax</span>           <span class="token comment">;; height = {a2}</span><br>b7  cmp <span class="token register variable">eax</span>,<span class="token number">0x1f40</span>              <span class="token comment">;; is height >= 4000?</span><br>bc  jng <span class="token number">0x36ec4a32</span>  <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0xf2</span><span class="token operator">></span><br>                  <span class="token operator">-</span><span class="token operator">-</span> B8 start <span class="token operator">-</span><span class="token operator">-</span><br>                  <span class="token operator">-</span><span class="token operator">-</span> B9 start <span class="token operator">-</span><span class="token operator">-</span><br>c2  <span class="token keyword">mov</span> <span class="token register variable">edx</span>,<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">0x14</span><span class="token operator">]</span>          <span class="token comment">;; retrieve argument {a3}</span><br>c5  test_b <span class="token register variable">dl</span>,<span class="token number">0x1</span><br>c8  jnz <span class="token number">0x36ec4a81</span>  <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0x141</span><span class="token operator">></span><br>ce  <span class="token keyword">mov</span> <span class="token register variable">esi</span>,<span class="token number">0x466473ad</span>          <span class="token comment">;; object: 0x466473ad &lt;Map(HOLEY_ELEMENTS)></span><br>d3  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">-</span><span class="token number">0x1</span><span class="token operator">]</span>,<span class="token register variable">esi</span>           <span class="token comment">;; push the map forward</span><br>d6  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">0x13</span><span class="token operator">]</span>,<span class="token register variable">edx</span>          <span class="token comment">;; prominence = {a3}</span><br>d9  <span class="token keyword">mov</span> <span class="token register variable">esi</span>,<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">0x18</span><span class="token operator">]</span>          <span class="token comment">;; retrieve argument {a4}</span><br>dc  test_w <span class="token register variable">esi</span>,<span class="token number">0x1</span><br>e1  jz <span class="token number">0x36ec4a8b</span>  <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0x14b</span><span class="token operator">></span><br>e7  <span class="token keyword">mov</span> <span class="token register variable">edi</span>,<span class="token number">0x466473d5</span>          <span class="token comment">;; object: 0x466473d5 &lt;Map(HOLEY_ELEMENTS)></span><br>ec  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">-</span><span class="token number">0x1</span><span class="token operator">]</span>,<span class="token register variable">edi</span>           <span class="token comment">;; push the map forward to the leaf map</span><br>ef  <span class="token keyword">mov</span> <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">0x17</span><span class="token operator">]</span>,<span class="token register variable">esi</span>          <span class="token comment">;; isClimbed = {a4}</span><br>                  <span class="token operator">-</span><span class="token operator">-</span> B10 start (deconstruct frame) <span class="token operator">-</span><span class="token operator">-</span><br>f2  <span class="token keyword">mov</span> <span class="token register variable">eax</span>,<span class="token register variable">ecx</span>                 <span class="token comment">;; get ready to return this great Peak object!</span><br>…</code></pre><p>BTW, to see all this you should have a debug build and pass a few flags. I put the code into a file and called:<pre class=language-bash><code class=language-bash>./d8 --allow-natives-syntax --trace-opt --code-comments --print-opt-code mycode.js</code></pre><p>I hope this has been a fun exploration. I’d like to say a very special thanks to Igor Sheludko and Maya Armyanova for (patiently!) reviewing this post.</div><footer><div><picture><source srcset="/_img/avatars/michael-stanton.avif, /_img/avatars/michael-stanton@2x.avif 2x" type=image/avif><img alt="" height=96 loading=lazy src=/_img/avatars/michael-stanton.jpg width=96 srcset="/_img/avatars/michael-stanton@2x.jpg 2x"></picture><p>作者：Michael Stanton (<a href=https://twitter.com/alpencoder>@alpencoder</a>), renowned master of <em>slack</em>.</div></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/blog/slack-tracking>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/blog/slack-tracking.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>