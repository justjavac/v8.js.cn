<!doctype html><html lang=zh-CN><meta charset=utf-8><title>Flake bisect · V8</title><meta content="width=device-width" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=" js"</script><meta content="This document explains how to bisect flaky tests." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li><a href=/blog/ >博客</a><li class=active><a href=/docs/ >文档</a><li><a href=/tools/ >工具</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><h1>Flake bisect</h1><p>Flaky tests are reported in a separate step on the bots (<a href=https://ci.chromium.org/ui/p/v8/builders/ci/V8%20Linux64%20TSAN/38630/overview>example build</a>).<p>Each test log provides a pre-filled command line for triggering an automated flake bisect, like:<pre><code>Trigger flake bisect on command line:
bb add v8/try.triggered/v8_flako -p 'to_revision="deadbeef"' -p 'test_name="MyTest"' ...
</code></pre><p>Before triggering flake bisects for the first time, users must log in with a google.com account:<pre class=language-bash><code class=language-bash>bb auth-login</code></pre><p>Then execute the provided command, which returns a build URL running flake bisect (<a href=https://ci.chromium.org/ui/p/v8/builders/try.triggered/v8_flako/b8836020260675019825/overview>example</a>).<p>If you’re in luck, bisection points you to a suspect. If not, you might want to read further…<h2 id=detailed-description>Detailed description <a href=#detailed-description class=bookmark>#</a></h2><p>For technical details, see also the implementation <a href=https://crbug.com/711249>tracker bug</a>. The flake bisect approach has the same intentions as <a href=https://sites.google.com/chromium.org/cat/findit>findit</a>, but uses a different implementation.<h3 id=how-does-it-work%3F>How does it work? <a href=#how-does-it-work%3F class=bookmark>#</a></h3><p>A bisect job has 3 phases: calibration, backwards and inwards bisection. During calibration, testing is repeated doubling the total timeout (or the number of repetitions) until enough flakes are detected in one run. Then, backwards bisection doubles the git range until a revision without flakes is found. At last, we bisect into the range of the good revision and the oldest bad one. Note, bisection doesn't produce new build products, it is purely based on builds previously created on V8's continuous infrastructure.<h3 id=bisection-fails-when%E2%80%A6>Bisection fails when… <a href=#bisection-fails-when%E2%80%A6 class=bookmark>#</a></h3><ul><li>No confidence can be reached during calibration. This is typical for one-in-a-million flakes or flaky behavior only visible when other tests run in parallel (e.g. memory hungry tests).<li>The culprit is too old. Bisection bails out after a certain number of steps, or if older builds are not available anymore on the isolate server.<li>The overall bisect job times out. In this case it might be possible to restart it with an older known bad revision.</ul><h2 id=properties-for-customizing-flake-bisect>Properties for customizing flake bisect <a href=#properties-for-customizing-flake-bisect class=bookmark>#</a></h2><ul><li><code>extra_args</code>: Extra arguments passed to V8’s <code>run-tests.py</code> script.<li>repetitions: Initial number of test repetitions (passed to <code>run-tests.py</code>'s <code>--random-seed-stress-count</code> option; unused if <code>total_timeout_sec</code> is used).<li><code>timeout_sec</code>: Timeout parameter passed to <code>run-tests.py</code>.<li><code>to_revision</code>: Revision known to be bad. This is where bisection will start.<li><code>total_timeout_sec</code>: Initial total timeout for one entire bisect step. During calibration, this time is doubled several times if needed. Set to 0 to disable and use the <code>repetitions</code> property instead.<li><code>variant</code>: Name of the testing variant passed to <code>run-tests.py</code>.</ul><h2 id=properties-you-won%E2%80%99t-need-to-change>Properties you won’t need to change <a href=#properties-you-won%E2%80%99t-need-to-change class=bookmark>#</a></h2><ul><li><code>bisect_buildername</code>: Master name of the builder that produced the builds for bisection.<li><code>bisect_mastername</code>: Name of the builder that produced the builds for bisection.<li><code>build_config</code>: Build config passed to V8’s <code>run-tests.py</code> script (there the parameter name is <code>--mode</code>, example: <code>Release</code> or <code>Debug</code>).<li><code>isolated_name</code>: Name of the isolated file (e.g. <code>bot_default</code>, <code>mjsunit</code>).<li><code>swarming_dimensions</code>: Swarming dimensions classifying the type of bot the tests should run on. Passed as list of strings, each in the format <code>name:value</code>.<li><code>test_name</code>: Fully qualified test name passed to run-tests.py. E.g. <code>mjsunit/foobar</code>.</ul><h2 id=tips-and-tricks>Tips and tricks <a href=#tips-and-tricks class=bookmark>#</a></h2><h3 id=bisecting-a-hanging-test-(e.g.-dead-lock)>Bisecting a hanging test (e.g. dead lock) <a href=#bisecting-a-hanging-test-(e.g.-dead-lock) class=bookmark>#</a></h3><p>If a failing run times out, while a pass is running very fast, it is useful to tweak the timeout_sec parameter, so that bisection is not delayed waiting for the hanging runs to time out. E.g. if the pass is usually reached in &lt;1 second, set the timeout to something small, e.g. 5 seconds.<h3 id=getting-more-confidence-on-a-suspect>Getting more confidence on a suspect <a href=#getting-more-confidence-on-a-suspect class=bookmark>#</a></h3><p>In some runs, confidence is very low. E.g. calibration is satisfied if four flakes are seen in one run. During bisection, every run with one or more flakes is counted as bad. In such cases it might be useful to restart the bisect job setting to_revision to the culprit and using a higher number of repetitions or total timeout than the original job and confirm that the same conclusion is reached again.<h3 id=working-around-timeout-issues>Working around timeout issues <a href=#working-around-timeout-issues class=bookmark>#</a></h3><p>In case the overall timeout option causes builds to hang, it’s best to estimate a fitting number of repetitions and set <code>total_timeout_sec</code> to <code>0</code>.<h3 id=test-behavior-depending-on-random-seed>Test behavior depending on random seed <a href=#test-behavior-depending-on-random-seed class=bookmark>#</a></h3><p>Rarely, a code path is only triggered with a particular random seed. In this case it might be beneficial to fix it using <code>extra_args</code>, e.g. <code>"extra_args": ["--random-seed=123"]</code>. Otherwise, the stress runner uses different random seeds throughout. Note though that a particular random seed might reproduce a problem in one revision, but not in another.</main><footer id=footer><div><nav><a href=https://v8.dev/docs/flake-bisect>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/docs/flake-bisect.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>