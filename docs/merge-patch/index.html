<!doctype html><html lang=zh-CN><meta charset=utf-8><title>Merging & patching · V8</title><meta content="width=device-width" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=" js"</script><meta content="This document explains how to merge V8 patches to the master branch." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li><a href=/blog/ >博客</a><li class=active><a href=/docs/ >文档</a><li><a href=/tools/ >工具</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><h1>Merging & patching</h1><p>If you have a patch to the <code>master</code> branch (e.g. an important bug fix) that needs to be merged into one of the production V8 branches, read on.<p>The following examples use a branched 2.4 version of V8. Substitute <code>2.4</code> with your version number. Read the documentation on <a href=/docs/release-process>V8’s release process</a> and <a href=/docs/version-numbers>V8’s version numbering</a> for more information.<p>An associated issue on Chromium’s or V8’s issue tracker is mandatory if a patch is merged. This helps with keeping track of merges. You can use <a href="https://code.google.com/p/v8/issues/entry?template=Merge%20request">a template</a> to create a merge request issue.<h2 id=what-qualifies-a-merge-candidate%3F>What qualifies a merge candidate? <a href=#what-qualifies-a-merge-candidate%3F class=bookmark>#</a></h2><ul><li>The patch fixes a <em>severe</em> bug (in order of importance):<ol><li>security bug<li>stability bug<li>correctness bug<li>performance bug</ol><li>The patch does not alter APIs.<li>The patch does not change behavior present before branch cut (except if the behavior change fixes a bug).</ul><p>More information can be found on the <a href=https://www.chromium.org/developers/the-zen-of-merge-requests>relevant Chromium page</a>. When in doubt, send an email to <a href=mailto:v8-dev@googlegroups.com>v8-dev@googlegroups.com</a>.<h2 id=the-merge-process>The merge process <a href=#the-merge-process class=bookmark>#</a></h2><p>The merge process in the Chromium and V8 tracker is driven by labels in the form of:<pre><code>Merge-[Status]-[Branch]
</code></pre><p>The currently important labels for V8 are:<ol><li><code>Merge-Request-{Branch}</code> initiates the process, and means that this fix should be merged into <code>{Branch}</code>. <code>{Branch}</code> is the name/number of the V8 branch e.g. <code>7.2</code> for M72.<li><code>Merge-Review-{Branch}</code> means the merge is not approved yet for <code>{Branch}</code> e.g. because Canary coverage is missing.<li><code>Merge-Approved-{Branch}</code> means that the Chrome TPMs have signed off on the merge.<li>When the merge is done, the <code>Merge-Approved-{Branch}</code> label is replaced with <code>Merge-Merged-{Branch}</code>.</ol><h2 id=how-to-check-if-a-commit-was-already-merged%2Freverted%2Fhas-canary-coverage>How to check if a commit was already merged/reverted/has Canary coverage <a href=#how-to-check-if-a-commit-was-already-merged%2Freverted%2Fhas-canary-coverage class=bookmark>#</a></h2><p>Use <code>mergeinfo.py</code> to get all the commits which are connected to the <code>$COMMIT_HASH</code> according to Git.<pre class=language-bash><code class=language-bash>tools/release/mergeinfo.py <span class="token variable">$COMMIT_HASH</span></code></pre><p>If it tells you <code>Is on Canary: No Canary coverage</code> you should not merge yet because the fix was not yet deployed on a Canary build. A good rule of the thumb is to wait at least 3 days after the fix has landed until the merge is conducted.<h2 id=how-to-create-the-merge-cl>How to create the merge CL <a href=#how-to-create-the-merge-cl class=bookmark>#</a></h2><h3 id=option-1%3A-using-gerrit>Option 1: Using <a href=https://chromium-review.googlesource.com/ >gerrit</a> <a href=#option-1%3A-using-gerrit class=bookmark>#</a></h3><p>Note that this option only works if the patch applies cleanly on the release branch.<ol><li>Open the CL you want to back-merge.<li>Select "Cherry pick" from the extended menu (three vertical dots in the upper right corner).<li>Enter "refs/branch-heads/<em>X.X</em>" as destination branch (replace <em>X.X</em> by the proper branch).<li>Modify the commit message:<ol><li>Prefix the title with "Merged: ".<li>Remove lines from the footer that correspond to the original CL ("Change-Id", "Reviewed-on", "Reviewed-by", "Commit-Queue", "Cr-Commit-Position"). Definitely keep the "(cherry picked from commit XXX)" line, as this is needed by some tools to relate merges to original CLs.</ol><li>In case of merge conflict, please also go ahead and create the CL. To resolve conflicts (if any) - either using the gerrit UI or you can easily pull the patch locally by using the "download patch" command from the menu (three vertical dots in the upper right corner).<li>Send out for review.</ol><h3 id=option-2%3A-using-the-automated-script>Option 2: Using the automated script <a href=#option-2%3A-using-the-automated-script class=bookmark>#</a></h3><p>Let’s assume you’re merging revision af3cf11 to branch 2.4 (please specify full git hashes - abbreviations are used here for simplicity).<pre class=language-bash><code class=language-bash>tools/release/merge_to_branch.py --branch <span class="token number">2.4</span> af3cf11</code></pre><p>Run the script with <code>-h</code> to display its help message, which includes more options (e.g. you can specify a file containing your patch, or you can reverse a patch, specify a custom commit message, or resume a merging process you’ve canceled before). Note that the script will use a temporary checkout of V8 - it won’t touch your work space. You can also merge more than one revision at once; just list them all.<pre class=language-bash><code class=language-bash>tools/release/merge_to_branch.py --branch <span class="token number">2.4</span> af3cf11 cf33f1b sf3cf09</code></pre><h3 id=after-landing%3A-observe-the-branch-waterfall>After landing: Observe the <a href=https://ci.chromium.org/p/v8>branch waterfall</a> <a href=#after-landing%3A-observe-the-branch-waterfall class=bookmark>#</a></h3><p>If one of the builders is not green after handling your patch, revert the merge immediately. A bot (<code>AutoTagBot</code>) takes care of the correct versioning after a 10-minute wait.<h2 id=patching-a-version-used-on-canary%2Fdev>Patching a version used on Canary/Dev <a href=#patching-a-version-used-on-canary%2Fdev class=bookmark>#</a></h2><p>In case you need to patch a Canary/Dev version (which should not happen often), follow these instructions:<h3 id=step-1%3A-merge-to-roll-branch>Step 1: Merge to roll branch <a href=#step-1%3A-merge-to-roll-branch class=bookmark>#</a></h3><p>Example version used is <code>5.7.433</code>.<pre class=language-bash><code class=language-bash>tools/release/roll_merge.py --branch <span class="token number">5.7</span>.433 af3cf11</code></pre><h3 id=step-2%3A-make-chromium-aware-of-the-fix>Step 2: Make Chromium aware of the fix <a href=#step-2%3A-make-chromium-aware-of-the-fix class=bookmark>#</a></h3><p>Example Chromium branch used is <code>2978</code>:<pre class=language-bash><code class=language-bash><span class="token function">git</span> checkout chromium/2978<br><span class="token function">git</span> merge <span class="token number">5.7</span>.433.1<br><span class="token function">git</span> push</code></pre><h3 id=step-3%3A-the-end>Step 3: The end <a href=#step-3%3A-the-end class=bookmark>#</a></h3><p>Chrome/Chromium should pick up the change when they build automatically.<h2 id=faq>FAQ <a href=#faq class=bookmark>#</a></h2><h3 id=i-get-an-error-during-merge-that-is-related-to-tagging.-what-should-i-do%3F>I get an error during merge that is related to tagging. What should I do? <a href=#i-get-an-error-during-merge-that-is-related-to-tagging.-what-should-i-do%3F class=bookmark>#</a></h3><p>When two people are merging at the same time a race condition can happen in the merge scripts. If this is the case, contact <a href=mailto:machenbach@chromium.org>machenbach@chromium.org</a> and <a href=mailto:hablich@chromium.org>hablich@chromium.org</a>.<h3 id=is-there-a-tl%3Bdr%3F>Is there a TL;DR? <a href=#is-there-a-tl%3Bdr%3F class=bookmark>#</a></h3><ol><li><a href="https://bugs.chromium.org/p/v8/issues/entry?template=Merge%20request">Create an issue on the issue tracker</a>.<li>Check status of the fix with <code>tools/release/mergeinfo.py</code><li>Add <code>Merge-Request-{Branch}</code> to the issue.<li>Wait until somebody adds <code>Merge-Approved-{Branch}</code>.<li><a href=#step-1-run-the-script>Merge</a>.</ol></main><footer id=footer><div><nav><a href=https://v8.dev/docs/merge-patch>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/docs/merge-patch.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>